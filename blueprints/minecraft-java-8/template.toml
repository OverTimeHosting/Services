[game]
type = "minecraft"
startup_file = "server.jar"
version_source = "vanilla_api"
supported_versions = "1.0 - 1.11.2"

[variables]
VANILLA_VERSION = "1.8.9"
SERVER_JARFILE = "server.jar"
JAVA_MEMORY = "2G"
SERVER_PORT = "25565"
EULA = "true"

[config]
[config.env]
VANILLA_VERSION = "${VANILLA_VERSION}"
SERVER_JARFILE = "${SERVER_JARFILE}"
JAVA_MEMORY = "${JAVA_MEMORY}"
SERVER_PORT = "${SERVER_PORT}"
EULA = "${EULA}"

[install_script]
script = '''
#!/bin/sh
# Vanilla MC Installation Script
# Compatible with Minecraft 1.0 - 1.11.2
# Server Files: /mnt/server

# Install jq and curl if not present
install_deps() {
  if command -v apk > /dev/null 2>&1; then
    echo "Detected Alpine, using apk..."
    apk add --no-cache jq curl
  elif command -v apt-get > /dev/null 2>&1; then
    echo "Detected Debian/Ubuntu, using apt-get..."
    apt-get update && apt-get install -y jq curl
  elif command -v yum > /dev/null 2>&1; then
    echo "Detected RHEL/CentOS, using yum..."
    yum install -y jq curl
  else
    echo "WARNING: Unknown package manager, assuming jq and curl are available"
  fi
}

if ! command -v jq > /dev/null 2>&1 || ! command -v curl > /dev/null 2>&1; then
  install_deps
fi

mkdir -p /mnt/server
cd /mnt/server

echo "Fetching version manifest..."
MANIFEST=$(curl -sSL https://launchermeta.mojang.com/mc/game/version_manifest.json)

LATEST_VERSION=$(echo "$MANIFEST" | jq -r '.latest.release')
LATEST_SNAPSHOT_VERSION=$(echo "$MANIFEST" | jq -r '.latest.snapshot')

echo "Latest version is $LATEST_VERSION"
echo "Latest snapshot is $LATEST_SNAPSHOT_VERSION"

if [ -z "$VANILLA_VERSION" ] || [ "$VANILLA_VERSION" = "latest" ]; then
  VERSION_TO_USE="$LATEST_VERSION"
elif [ "$VANILLA_VERSION" = "snapshot" ]; then
  VERSION_TO_USE="$LATEST_SNAPSHOT_VERSION"
else
  VERSION_TO_USE="$VANILLA_VERSION"
fi

echo "Installing Minecraft version: $VERSION_TO_USE"

MANIFEST_URL=$(echo "$MANIFEST" | jq --arg VERSION "$VERSION_TO_USE" -r '.versions[] | select(.id == $VERSION) | .url')

if [ -z "$MANIFEST_URL" ]; then
  echo "ERROR: Version $VERSION_TO_USE not found!"
  exit 1
fi

VERSION_MANIFEST=$(curl -sSL "$MANIFEST_URL")
DOWNLOAD_URL=$(echo "$VERSION_MANIFEST" | jq -r '.downloads.server.url')

if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
  echo "ERROR: No server download URL found for version $VERSION_TO_USE"
  exit 1
fi

echo "Downloading server from: $DOWNLOAD_URL"
curl -sSL -o "${SERVER_JARFILE:-server.jar}" "$DOWNLOAD_URL"

echo "eula=true" > eula.txt

echo "Install Complete!"
'''
