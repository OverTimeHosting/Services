[game]
type = "minecraft"
startup_file = "server.jar"
version_source = "vanilla_api"
supported_versions = "1.20.5+"

[variables]
VANILLA_VERSION = "latest"
SERVER_JARFILE = "server.jar"
JAVA_MEMORY = "2G"
SERVER_PORT = "25565"
EULA = "true"

[config]
[config.env]
VANILLA_VERSION = "${VANILLA_VERSION}"
SERVER_JARFILE = "${SERVER_JARFILE}"
JAVA_MEMORY = "${JAVA_MEMORY}"
SERVER_PORT = "${SERVER_PORT}"
EULA = "${EULA}"

[install_script]
script = '''
#!/bin/sh
# Vanilla MC Installation Script
# Compatible with Minecraft 1.20.5+
# Server Files: /mnt/server

# Setup jq - download static binary if not available
setup_jq() {
  if command -v jq > /dev/null 2>&1; then
    JQ_CMD="jq"
    return 0
  fi

  echo "jq not found, downloading static binary..."

  # Detect architecture
  ARCH=$(uname -m)
  case "$ARCH" in
    x86_64|amd64) JQ_ARCH="jq-linux-amd64" ;;
    aarch64|arm64) JQ_ARCH="jq-linux-arm64" ;;
    armv7l|armhf) JQ_ARCH="jq-linux-armhf" ;;
    i386|i686) JQ_ARCH="jq-linux-i386" ;;
    *) echo "ERROR: Unsupported architecture: $ARCH"; exit 1 ;;
  esac

  # Download jq to temp location
  JQ_URL="https://github.com/jqlang/jq/releases/download/jq-1.7.1/${JQ_ARCH}"
  curl -sSL -o /tmp/jq "$JQ_URL"
  chmod +x /tmp/jq
  JQ_CMD="/tmp/jq"

  if [ ! -x "$JQ_CMD" ]; then
    echo "ERROR: Failed to download jq"
    exit 1
  fi

  echo "jq downloaded successfully"
}

setup_jq

mkdir -p /mnt/server
cd /mnt/server

# Use temp files to avoid shell escaping issues with JSON
MANIFEST_FILE="/tmp/mc_manifest.json"
VERSION_FILE="/tmp/mc_version.json"

echo "Fetching version manifest..."
curl -sSL -o "$MANIFEST_FILE" https://launchermeta.mojang.com/mc/game/version_manifest.json

LATEST_VERSION=$($JQ_CMD -r '.latest.release' "$MANIFEST_FILE")
LATEST_SNAPSHOT_VERSION=$($JQ_CMD -r '.latest.snapshot' "$MANIFEST_FILE")

echo "Latest version is $LATEST_VERSION"
echo "Latest snapshot is $LATEST_SNAPSHOT_VERSION"

if [ -z "$VANILLA_VERSION" ] || [ "$VANILLA_VERSION" = "latest" ]; then
  VERSION_TO_USE="$LATEST_VERSION"
elif [ "$VANILLA_VERSION" = "snapshot" ]; then
  VERSION_TO_USE="$LATEST_SNAPSHOT_VERSION"
else
  VERSION_TO_USE="$VANILLA_VERSION"
fi

echo "Installing Minecraft version: $VERSION_TO_USE"

MANIFEST_URL=$($JQ_CMD --arg VERSION "$VERSION_TO_USE" -r '.versions[] | select(.id == $VERSION) | .url' "$MANIFEST_FILE")

if [ -z "$MANIFEST_URL" ]; then
  echo "ERROR: Version $VERSION_TO_USE not found!"
  rm -f "$MANIFEST_FILE" "$VERSION_FILE"
  exit 1
fi

curl -sSL -o "$VERSION_FILE" "$MANIFEST_URL"
DOWNLOAD_URL=$($JQ_CMD -r '.downloads.server.url' "$VERSION_FILE")

if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
  echo "ERROR: No server download URL found for version $VERSION_TO_USE"
  rm -f "$MANIFEST_FILE" "$VERSION_FILE"
  exit 1
fi

echo "Downloading server from: $DOWNLOAD_URL"
curl -sSL -o "${SERVER_JARFILE:-server.jar}" "$DOWNLOAD_URL"

# Cleanup temp files
rm -f "$MANIFEST_FILE" "$VERSION_FILE"

echo "eula=true" > eula.txt

echo "Install Complete!"
'''
